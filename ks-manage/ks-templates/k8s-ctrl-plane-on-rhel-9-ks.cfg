# Generated by Anaconda 34.25.3.8
# Generated by pykickstart v3.32
#version=RHEL9
# Use Text install
#text
# Use Graphical install
graphical

#%addon com_redhat_kdump --enable --reserve-mb='auto'
%addon com_redhat_kdump --disable

%end

# Keyboard layouts
keyboard --xlayouts='in (eng)'
# System language
lang en_IN.UTF-8

# Network information

network --bootproto=static --ip=get_ipv4_address --netmask=get_ipv4_netmask --gateway=get_ipv4_gateway --nameserver=get_ipv4_nameserver --device=link --noipv6 --onboot=on --ipv4-dns-search=get_ipv4_domain --hostname=get_hostname.get_ipv4_domain --activate

%packages
@^minimal-environment
vim
bash-completion
cifs-utils
nfs-utils
bind-utils
tmux
ftp
tftp
net-tools
wget
rsync
sysstat
zip
tcpdump
traceroute
nc
samba-client
lsof
%end

# Run the Setup Agent on first boot
firstboot --enable

# File System Creation
ignoredisk --only-use=nvme0n1
clearpart --all --initlabel
bootloader --location=mbr --boot-drive=nvme0n1 --append='crashkernel=no ipv6.disable=1'
part /boot/efi --label=FIRMWARE --size=128          --asprimary --fstype=efi
part /boot     --label=BOOT     --size=512         --asprimary --fstype=xfs
part pv.01     --label=VOLUMES  --size=1024  --grow --asprimary
volgroup rhel pv.01
logvol /       --label=ROOT     --size=1024  --grow --vgname=rhel --name=root --fstype=xfs


selinux  --disabled

#Enable Services
#services --enabled=rhcd.service,cockpit.socket
#services --enabled=rhcd.service
#Disable Services
#services --disabled=firewalld.service

#Register system with Red Hat
#rhsm --organization="8051660" --activation-key=get_rhel_activation_key --connect-to-insights
rhsm --organization="8051660" --activation-key=get_rhel_activation_key

# Intended system purpose

timesource --ntp-pool=get_ntp_pool_name.get_ipv4_domain
# System timezone
timezone Asia/Kolkata --utc

# Root password
rootpw --iscrypted $6$lszCEKBW0uYUhm5N$16w1FJB/zUMQCVvTWQxtye0TqX7yDEM87HP2Lz84bqPCGvry4B8cWYcaClJsPCmPs4Z1/TSKkFdsK/u/WJg990
user --groups=wheel --name=muthuks --password=$6$lszCEKBW0uYUhm5N$16w1FJB/zUMQCVvTWQxtye0TqX7yDEM87HP2Lz84bqPCGvry4B8cWYcaClJsPCmPs4Z1/TSKkFdsK/u/WJg990 --iscrypted --gecos="muthuks"

eula --agreed

# POST-INSTALLATION SCRIPT
%post --interpreter=/usr/bin/bash --log=/root/anaconda-ks-post.log --erroronfail
# Enable CodeReady Builder repo (requires `epel-release` package).
#/sbin/subscription-manager repos --enable codeready-builder-for-rhel-9-$(arch)-rpms
#/usr/bin/dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm -y
#/usr/bin/dnf install https://dl.fedoraproject.org/pub/epel/epel-next-release-latest-9.noarch.rpm -y
#dnf install \
#http://get_web_server_name.get_ipv4_domain/epel-9/epel-next-release-latest-9.noarch.rpm \
#http://get_web_server_name.get_ipv4_domain/epel-9/epel-release-latest-9.noarch.rpm -y
#/usr/bin/mkdir /etc/yum.repos.d/EPEL
#/usr/bin/mv /etc/yum.repos.d/epel* /etc/yum.repos.d/EPEL/

# Attaching Red Hat Beta Access Subscription
#/sbin/subscription-manager attach --pool=2c9478828c5952d5018c64400d9d61d0

/bin/chmod +x /etc/rc.d/rc.local

###### Configuring Custom Network with Network Manager ######

mkdir -p /root/system-connections/orig-during-install

/bin/rsync -avPh /etc/NetworkManager/system-connections/* /root/system-connections/orig-during-install/

v_count=0
for v_interface_file in $(/bin/ls /etc/NetworkManager/system-connections/)
do
        /bin/mv /etc/NetworkManager/system-connections/$v_interface_file /etc/NetworkManager/system-connections/eth$v_count.nmconnection
        v_interface=$(/bin/echo $v_interface_file | /bin/cut -d "." -f 1)
        /bin/sed -i "s/$v_interface/eth$v_count/g" /etc/NetworkManager/system-connections/eth$v_count.nmconnection
        v_count=$((v_count+1))
done

#/bin/sed -n  '/connection/,/^$/p' /etc/NetworkManager/system-connections/eth0.nmconnection >/root/eth0-connection-info
#/bin/cat /root/eth0-connection-info >/etc/NetworkManager/system-connections/eth0.nmconnection
#/usr/bin/echo -e "[ipv4]\naddress1=192.168.168.100/24,192.168.168.1\naddress2=192.168.168.111/24\ndns=192.168.168.201;\ndns-search=ms.local;\nmethod=manual\n\n[ipv6]\nmethod=disabled" >>/etc/NetworkManager/system-connections/eth0.nmconnection

/bin/mv /etc/NetworkManager/system-connections/eth* /root/system-connections

/bin/rm -rf /etc/NetworkManager/system-connections/*

/bin/rsync -avPh /root/system-connections/* /etc/NetworkManager/system-connections/.

/bin/mkdir -p /etc/systemd/network

V_count=0
for v_interface in $(/bin/ls /sys/class/net | /bin/grep -v lo)
do
        /bin/echo -e "[Match]\nMACAddress=$(/sbin/ip link | /bin/grep $v_interface -A 1 | /bin/grep link/ether | /bin/cut -d " " -f 6)\n\n[Link]\nName=eth$V_count" >/etc/systemd/network/7$V_count-eth$V_count.link
V_count=$((V_count+1))
done

#################################################################

#/bin/systemctl mask kdump
#/bin/systemctl mask firewalld
/bin/unlink /etc/systemd/system/multi-user.target.wants/kdump.service
/bin/unlink /etc/systemd/system/multi-user.target.wants/firewalld.service
/bin/unlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service

/bin/mkdir -p /home/muthuks/.ssh /root/.ssh
/bin/chmod 0700 /home/muthuks/.ssh /root/.ssh
/bin/wget -O /home/muthuks/.ssh/authorized_keys http://get_web_server_name.get_ipv4_domain/addons-for-kickstarts/authorized_keys
/bin/wget -O /root/.ssh/authorized_keys http://get_web_server_name.get_ipv4_domain/addons-for-kickstarts/authorized_keys
/bin/wget -O /root/.ssh/id_rsa-server http://get_web_server_name.get_ipv4_domain/server/id_rsa-server
/bin/chmod 0600 /home/muthuks/.ssh/authorized_keys /root/.ssh/authorized_keys /root/.ssh/id_rsa-server
/bin/chown -R muthuks:muthuks /home/muthuks/.ssh

/usr/bin/echo -e "HISTSIZE=-1\nHISTFILESIZE=-1" | /usr/bin/tee -a /home/muthuks/.bashrc /root/.bashrc
var_PS1_variable_muthuks=$(/usr/bin/curl -s -L http://get_web_server_name.get_ipv4_domain/addons-for-kickstarts/PS1-env-variable-normal-user)
/usr/bin/echo "${var_PS1_variable_muthuks}" >> /home/muthuks/.bashrc
var_PS1_variable_root=$(/usr/bin/curl -s -L http://get_web_server_name.get_ipv4_domain/addons-for-kickstarts/PS1-env-variable-root-user)
/usr/bin/echo "${var_PS1_variable_root}" >> /root/.bashrc
/usr/bin/echo "muthuks ALL=(ALL) NOPASSWD:ALL" >/etc/sudoers.d/muthuks

/bin/mkdir -p /home/muthuks/install-k8s-on-linux
/bin/wget -P /home/muthuks/install-k8s-on-linux/ http://get_web_server_name.get_ipv4_domain/k8s-install/install-k8s-on-linux.sh
/bin/wget -P /home/muthuks/install-k8s-on-linux/ http://get_web_server_name.get_ipv4_domain/k8s-install/install-k8s-on-linux-ctrl-plane.service
/bin/sed -i "s/ks-manager-provided-web-server-name/get_web_server_name.get_ipv4_domain/g" /home/muthuks/install-k8s-on-linux/install-k8s-on-linux.sh
/bin/chown -R muthuks:muthuks /home/muthuks/install-k8s-on-linux
/bin/cp -p /home/muthuks/install-k8s-on-linux/install-k8s-on-linux-ctrl-plane.service /etc/systemd/system/
/bin/ln -s /etc/systemd/system/install-k8s-on-linux-ctrl-plane.service /etc/systemd/system/multi-user.target.wants/install-k8s-on-linux-ctrl-plane.service 

/bin/wget -P /etc/pki/ca-trust/source/anchors/ http://get_web_server_name.get_ipv4_domain/addons-for-kickstarts/ca-certs/get_web_server_name.get_ipv4_domain-apache-selfsigned.crt
/bin/update-ca-trust

#Keeping Restoring Host Keys Same and Enabling passwordless authentication with server
##################
#/bin/wget -P /root/ http://get_web_server_name.get_ipv4_domain/muthuks-k8s-ctrl-plane/muthuks-k8s-ctrl-plane-ssh.tar.gz
#/bin/tar -xzvf /root/muthuks-k8s-ctrl-plane-ssh.tar.gz -C /root/
#/bin/rsync -avPh /root/muthuks-k8s-ctrl-plane-ssh/host-key-ssh/ /etc/ssh/
#/bin/mkdir -p /home/muthuks/.ssh /root/.ssh
#/bin/chmod 0700 /home/muthuks/.ssh /root/.ssh
#/bin/rsync -avPh /root/muthuks-k8s-ctrl-plane-ssh/muthuks-ssh/ /home/muthuks/.ssh/
#/bin/rsync -avPh /root/muthuks-k8s-ctrl-plane-ssh/root-ssh/ /root/.ssh/
#/bin/chown -R muthuks:muthuks /home/muthuks/.ssh
#####/bin/rm -rf /root/muthuks*
##################

%end

reboot --eject
